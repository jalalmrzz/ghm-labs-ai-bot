<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName jalal.publicvm.com
    DocumentRoot /var/www/html/ghm-training
    
    <Directory /var/www/html/ghm-training>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    SSLProxyEngine On
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

    RewriteEngine On
    
    # ╔══════════════════════════════════════════════════════════════════╗
    # ║  ALL-IN-ONE REWRITE: Security + Proxy using [P] flag            ║
    # ║  NO ProxyPass directive - everything through RewriteRule        ║
    # ╚══════════════════════════════════════════════════════════════════╝
    
    # RULE 1: Allow OPTIONS preflight (return 204)
    RewriteCond %{REQUEST_URI} ^/v1/chat/completions$
    RewriteCond %{REQUEST_METHOD} ^OPTIONS$
    RewriteRule ^ - [R=204,L]
    
    # RULE 2: BLOCK - No valid Origin
    RewriteCond %{REQUEST_URI} ^/v1/chat/completions$
    RewriteCond %{REQUEST_METHOD} ^POST$
    RewriteCond %{HTTP:Origin} !^https://jalal\.publicvm\.com$
    RewriteRule ^ - [F,L]
    
    # RULE 3: BLOCK - No valid client header
    RewriteCond %{REQUEST_URI} ^/v1/chat/completions$
    RewriteCond %{REQUEST_METHOD} ^POST$
    RewriteCond %{HTTP:X-GHM-Client} !^ghm-training-app$
    RewriteRule ^ - [F,L]
    
    # RULE 4: PROXY - Only if security passed (set API key via RequestHeader)
    RewriteCond %{REQUEST_URI} ^/v1/chat/completions$
    RewriteCond %{REQUEST_METHOD} ^POST$
    RewriteRule ^/v1/chat/completions$ https://api.groq.com/openai/v1/chat/completions [P,L]
    
    # Set API key for proxied requests
    <Location /v1/chat/completions>
        Include /etc/apache2/ghm-api-key.conf
        
        # CORS headers  
        Header always set Access-Control-Allow-Origin "https://jalal.publicvm.com"
        Header always set Access-Control-Allow-Methods "POST, OPTIONS"
        Header always set Access-Control-Allow-Headers "Content-Type, X-GHM-Client"
        Header always set Access-Control-Max-Age "86400"
        Header always set X-Frame-Options "DENY"
        Header always set X-Content-Type-Options "nosniff"
    </Location>
    
    # Reverse proxy for response
    ProxyPassReverse /v1/chat/completions https://api.groq.com/openai/v1/chat/completions

    SSLCertificateFile /etc/letsencrypt/live/jalal.publicvm.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/jalal.publicvm.com/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
</IfModule>
