<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName jalal.publicvm.com
    DocumentRoot /var/www/html/ghm-training
    
    <Directory /var/www/html/ghm-training>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    SSLProxyEngine On
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

    ProxyPass /v1/chat/completions https://api.groq.com/openai/v1/chat/completions
    ProxyPassReverse /v1/chat/completions https://api.groq.com/openai/v1/chat/completions
    
    # ╔══════════════════════════════════════════════════════════════════╗
    # ║  MAXIMUM SECURITY: MULTI-LAYER CORS + ORIGIN PROTECTION          ║
    # ╚══════════════════════════════════════════════════════════════════╝
    
    <Location /v1/chat/completions>
        # Inject API key server-side (loaded from separate config file, not in git)
        # The key is stored in /etc/apache2/ghm-api-key.conf
        Include /etc/apache2/ghm-api-key.conf
        
        # ══════════ LAYER 1: STRICT CORS HEADERS ══════════
        # Only YOUR domain can make requests
        Header always set Access-Control-Allow-Origin "https://jalal.publicvm.com"
        Header always set Access-Control-Allow-Methods "POST"
        Header always set Access-Control-Allow-Headers "Content-Type, X-GHM-Client"
        Header always set Access-Control-Max-Age "86400"
        # Prevent embedding/framing
        Header always set X-Frame-Options "DENY"
        Header always set X-Content-Type-Options "nosniff"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        
        # ══════════ LAYER 2: BLOCK ALL NON-POST METHODS ══════════
        # Only POST allowed (no GET, PUT, DELETE, etc.)
        <LimitExcept POST OPTIONS>
            Require all denied
        </LimitExcept>
        
        # ══════════ LAYER 3: ORIGIN HEADER VALIDATION ══════════
        # Must have valid Origin header from our domain
        <If "%{REQUEST_METHOD} == 'POST'">
            <If "! %{HTTP:Origin} =~ m#^https://jalal\.publicvm\.com$#">
                Require all denied
            </If>
        </If>
        
        # ══════════ LAYER 4: REFERER VALIDATION ══════════
        # Referer must also be from our domain (double-check)
        <If "%{REQUEST_METHOD} == 'POST'">
            <If "%{HTTP:Referer} != '' && ! %{HTTP:Referer} =~ m#^https://jalal\.publicvm\.com#">
                Require all denied
            </If>
        </If>
        
        # ══════════ LAYER 5: CONTENT-TYPE ENFORCEMENT ══════════
        # Must be application/json - blocks form submissions
        <If "%{REQUEST_METHOD} == 'POST'">
            <If "! %{HTTP:Content-Type} =~ m#application/json#">
                Require all denied
            </If>
        </If>
        
        # ══════════ LAYER 6: CUSTOM HEADER REQUIREMENT ══════════
        # Requires a custom header that only our JS sends
        # This FORCES a preflight, making CSRF nearly impossible
        <If "%{REQUEST_METHOD} == 'POST'">
            <If "! %{HTTP:X-GHM-Client} == 'ghm-training-app'">
                Require all denied
            </If>
        </If>
    </Location>
    
    # Handle CORS preflight OPTIONS requests
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} =OPTIONS
    RewriteCond %{REQUEST_URI} ^/v1/chat/completions$
    RewriteRule ^ - [R=204,L]
    
    # ╔══════════════════════════════════════════════════════════════════╗
    # ║  END SECURITY BLOCK                                              ║
    # ╚══════════════════════════════════════════════════════════════════╝

    SSLCertificateFile /etc/letsencrypt/live/jalal.publicvm.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/jalal.publicvm.com/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
</IfModule>
